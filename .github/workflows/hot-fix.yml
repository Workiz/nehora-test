name: hot fix
on:
  workflow_dispatch:

jobs:
  hot-fix:
    name: hot-fix
    runs-on: ubuntu-latest
    steps:
    - name: Checkout 
      uses: actions/checkout@v3
    - name: checkour workiz-actions
      uses: actions/checkout@v3
      with:
        repository: Workiz/workiz-actions
        ref: workiz.com
        token: ${{ secrets.GH_TOKEN_MARKIZ_BOT }}
        path: ./tmp/workiz-actions
    - run: |-
        echo "open workiz.com pr"
        workiz_pr_url=$(curl -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
        https://api.github.com/repos/Workiz/nehora-test/pulls \
        -d '{"title":"Amazing new feature","body":"Please pull these awesome changes in!","head":"'$GITHUB_REF_NAME'","base":"workiz.com"}' | jq .'html_url')
        git config --global --add safe.directory /github/workspace
        if [[ "$GITHUB_REF_NAME" =~ ^v[0-9]\.([0-9]*)?(-hf[0-9]*)?-branch$ ]]; then  
            branch_number=${BASH_REMATCH[1]}
        fi
        workiz_pr_url="${workiz_pr_url%\"}"
        workiz_pr_url="${workiz_pr_url#\"}"
        echo "workiz_pr_url $workiz_pr_url" >> $GITHUB_ENV
        rc_number=`expr $branch_number + 1`
        branch=$(curl -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
        https://api.github.com/repos/Workiz/nehora-test/branches/rc3.$rc_number-branch | jq .'name')
        
        if [[ branch ]]; then
          echo "open rc branch pr"
          rc_pr_url=$(curl -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/Workiz/nehora-test/pulls \
          -d '{"title":"Amazing new feature","body":"Please pull these awesome changes in!","head":"'$GITHUB_REF_NAME'","base":"'rc3.$rc_number-branch'"}' | jq .'html_url')
          rc_pr_url="${rc_pr_url%\"}"
          rc_pr_url="${rc_pr_url#\"}"
          echo "rc_pr_url $rc_pr_url" >> $GITHUB_ENV
        fi
    - name: Send slack msg 
      uses: ./tmp/workiz-actions/slack-msg
      with:
        CHANNEL: 'nehora'
        MESSAGE: 'please merge prs'
        SUCCESS: true
        WORKIZ_INFRA_AUTH: ${{ secrets.WORKIZ_INFRA_AUTH }}
        LINKS: '[{"name" :"github pull request","link": "$rc_pr_url"}, {"name" :"github pull request","link": "$rc_pr_url"}]'

