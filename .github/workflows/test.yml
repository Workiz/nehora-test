name: ☁️ TEST

on:
  workflow_dispatch:

env:
  PROJECT_ID: workiz-development
  GKE_CLUSTER: staging
  GKE_ZONE: us-central1	


jobs:
  create-staging-env:
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/791610978826/locations/global/workloadIdentityPools/gh-pool/providers/gh-provider
          service_account: github-actions-service-account@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
      - uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}
      - id: 'secrets'
        uses: 'google-github-actions/get-secretmanager-secrets@v2'
        with:
          secrets: |-
            GH_READONLY_TOKEN:${{ env.PROJECT_ID }}/GH_READONLY_TOKEN
            AZURE_HELM_VERSION:${{ env.PROJECT_ID }}/AZURE_HELM_VERSION
            WORKIZ_INFRA_AUTH:${{ env.PROJECT_ID }}/WORKIZ_INFRA_AUTH
            MARKIZBOT_COMMENT_TOKEN:${{ env.PROJECT_ID }}/MARKIZBOT_COMMENT_TOKEN
      - uses: azure/setup-helm@v4.1.0
        with:
          version: ${{ steps.secrets.outputs.AZURE_HELM_VERSION}} 
      - name: 'create matrix for all services'
        id: matrix
        run: |
          RELEASES_JSON=$(helm list --namespace staging -o json | jq -c '[.[].name]')
          ESCAPED_RELEASES_JSON=$(echo "$RELEASES_JSON" | sed 's/"/\\"/g')
          echo "matrix={\"test-group\":[\"groupA\",\"groupB\"]}" >> $GITHUB_OUTPUT
          echo "matrix={\"test-group\":[\"groupA\",\"groupB\"]}" 
          # echo "matrix={\"services\":$ESCAPED_RELEASES_JSON}" >> $GITHUB_OUTPUT
          echo "matrix={\"services\":$ESCAPED_RELEASES_JSON}"
  deploy-service:
    needs: create-staging-env
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.create-staging-env.outputs.matrix)}}
      fail-fast: false
      max-parallel: 40
    steps:
      - name: 'Deploy service'
        run: |
          echo "Deploying service ${{ matrix.services }}"
          IMAGE=$(helm get values ${{ matrix.services }} --namespace staging | grep 'tag:' | awk '{print $2}')
          STAGING_NAMESPACE="staging"
          TARGET_NAMESPACE="nehora"
          CHART_REPO="workiz-helm-repo/workiz-chart"
          SECRET_PROJECT_ID="workiz-development"
          TIMEOUT="300s"
          echo "Image: $IMAGE"
          # helm upgrade $RELEASE $CHART_REPO --namespace $ --set secretProjectId=$SECRET_PROJECT_ID --reuse-values --atomic --timeout $TIMEOUT --devel --install --debug \
          # --set secretProjectId=workiz-development \
          # --set gcpProjectId=workiz-development \
          # --set secretProjectId=workiz-development \
          # --set image.registry="gcr.io/workiz-development" \
          # --set image.tag=$IMAGE \
          # --set customNodeEnv=staging  
      
    